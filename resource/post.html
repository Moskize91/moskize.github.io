<html xmlns="http://www.w3.org/1999/xhtml"><head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8">
<title>ECMAScript 6，令Node.js也可以写出同步执行的代码（上） - MOsky的博客</title>
<script async="" src="//www.google-analytics.com/analytics.js"></script><script type="text/javascript" src="../public/lib/jquery-1.10.1.min.js"></script>
<script src="../public/js/resize.js" type="text/javascript"></script>
<link href="../public/css/syntax.css" rel="stylesheet" type="text/css">
<link href="../public/css/public2.css" rel="stylesheet" type="text/css">

<meta name="Title" content="ECMAScript 6，令Node.js也可以写出同步执行的代码（上）">


<meta name="Author" content="MOsky">


<meta name="Copyright" content="taozeyu.com">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49110461-1', 'taozeyu.com');
  ga('send', 'pageview');

</script>
        <script src="/public/js/article2.js" type="text/javascript"></script>
	<script type="text/javascript" async="" src="http://static.duoshuo.com/embed.js" charset="UTF-8"></script><style type="text/css">#yddContainer{display:block;font-family:Microsoft YaHei;position:relative;width:100%;height:100%;top:-4px;left:-4px;font-size:12px;border:1px solid}#yddTop{display:block;height:22px}#yddTopBorderlr{display:block;position:static;height:17px;padding:2px 28px;line-height:17px;font-size:12px;color:#5079bb;font-weight:bold;border-style:none solid;border-width:1px}#yddTopBorderlr .ydd-sp{position:absolute;top:2px;height:0;overflow:hidden}.ydd-icon{left:5px;width:17px;padding:0px 0px 0px 0px;padding-top:17px;background-position:-16px -44px}.ydd-close{right:5px;width:16px;padding-top:16px;background-position:left -44px}#yddKeyTitle{float:left;text-decoration:none}#yddMiddle{display:block;margin-bottom:10px}.ydd-tabs{display:block;margin:5px 0;padding:0 5px;height:18px;border-bottom:1px solid}.ydd-tab{display:block;float:left;height:18px;margin:0 5px -1px 0;padding:0 4px;line-height:18px;border:1px solid;border-bottom:none}.ydd-trans-container{display:block;line-height:160%}.ydd-trans-container a{text-decoration:none;}#yddBottom{position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;overflow:hidden;background-position:left -22px}.ydd-padding010{padding:0 10px}#yddWrapper{color:#252525;z-index:10001;background:url(chrome-extension://ibogfemlnclpecapkojhmanpiebldbnk/ab20.png);}#yddContainer{background:#fff;border-color:#4b7598}#yddTopBorderlr{border-color:#f0f8fc}#yddWrapper .ydd-sp{background-image:url(chrome-extension://ibogfemlnclpecapkojhmanpiebldbnk/ydd-sprite.png)}#yddWrapper a,#yddWrapper a:hover,#yddWrapper a:visited{color:#50799b}#yddWrapper .ydd-tabs{color:#959595}.ydd-tabs,.ydd-tab{background:#fff;border-color:#d5e7f3}#yddBottom{color:#363636}#yddWrapper{min-width:250px;max-width:400px;}</style><link type="text/css" rel="stylesheet" href="http://static.duoshuo.com/styles/embed.default.css?d6149e1c.css"></head>
<body style="">
    <div id="left-page" style="width: 120px; height: 452px;">
		<div class="blank"></div>
	<script class="T1xC6MXfthXXcWeqbX" type="text/javascript" src="http://assets.taobaoimages.com/analytics.js"></script></div>
	<div id="right-page" style="width: 320px; margin-left: 940px; height: 452px;">
		<div id="index">
			<div id="friendly-link">
				<div>友情链接</div>
				<a href=http://lian666.com>友情链接交换中心</a>
			</div>
		</div>
    </div>
    <div id="center-page" style="margin-left: 120px;">
        <div id="title">
    <div class="title">MOsky的博客</div>
    <div class="button">
        
            <a href="/" class="ele">主页</a>
        
        
            <a href="/about.html" class="ele">关于我</a>
        
        
            <span class="ele">文章内容</span>
        
    </div>
</div>
        <div id="article" class="buble-container">
            <div class="title can-select">ECMAScript 6，令Node.js也可以写出同步执行的代码（上）</div>
			
            
			<div class="content can-select">
			<h1 id="article-index-0">引言</h1>
<p>本人学习Node.js已有两周了，有点心得，写成文章，一方面便于今后自己查阅，另一方面巩固自己所学。如有错误，请诸位赏脸批评指教。</p>

<p>Node.js给我的第一印象就是，它的I/O操作是非阻塞的。非阻塞I/O带来了性能上的优势。与Java的阻塞式I/O操作做对比，Java程序需要从网络下载资源的时候，阻塞线程，当查询数据库的时候，阻塞线程，当读取文件的时候，阻塞线程。诸如此类的来自I/O的阻塞将浪费不少CPU的时间。如果心疼这些浪费的时间，那好，你就多开几个线程或进程。但这又引入了线程之间切换的代价。</p>

<p>
Node.js使用事件驱动机制，当涉及I/O操作时，代码异步执行。这样带来的另一个好处就是，不需要考虑麻烦的<b>线程安全</b>问题，因为到Node.js即便是单线程，也不会因为I/O阻塞而出现性能瓶颈。同样和Java做比较。Java因为性能问题而开多线程，因为开多线程而需要考虑线程安全问题。Node.js可不这样。君不知曾有人在多线程的情况下使用HashMap类而导致服务器崩溃，虽然这只能算自作自受（因为HashMap的API上明确告诉你HashMap是非线程安全的），但如果语言本身就令程序员无需担心线程安全问题，那么这种情况就不会因为程序员的粗心而发生了。</p>

<p>但非阻塞I/O操作也有令人不爽的地方，进行I/O操作的时候，只能<b>异步调用</b>。</p>

<h1 id="article-index-1">异步调用的缺点</h1>

<p>异步调用依赖回调函数，而回调函数的缺点更加显而易见。那就是代码难写，写出来以后可维护性差。如果不有意识地避免，很可能写出这种东西：</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>     <span class="nx">callback</span><span class="p">(</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">x2</span><span class="p">);</span>
<span class="lineno"> 3</span> <span class="p">}</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="lineno"> 6</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 7</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 8</span>         <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno"> 9</span>         <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">10</span>             <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno">11</span>             <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">12</span>                 <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno">13</span>                 <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">14</span>                     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno">15</span>                 <span class="p">});</span>
<span class="lineno">16</span>             <span class="p">});</span>
<span class="lineno">17</span>         <span class="p">});</span>
<span class="lineno">18</span>     <span class="p">});</span>
<span class="lineno">19</span> <span class="p">})();</span>
</code></pre></div>

<p>这种回调函数中嵌套回调函数的方法写起来麻烦，别人要读你的代码更加不知所云。因此，也许可以把流程拆解成若干函数，在异步调用时，将函数名作为回调函数参数传进去。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="nx">step0</span><span class="p">();</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kd">function</span> <span class="nx">step0</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 4</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 5</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">step2</span><span class="p">);</span>
<span class="lineno"> 6</span> <span class="p">};</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="kd">function</span> <span class="nx">step1</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 9</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno">10</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">step2</span><span class="p">);</span>
<span class="lineno">11</span> <span class="p">}</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="kd">function</span> <span class="nx">step2</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">14</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno">15</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">step2</span><span class="p">);</span>
<span class="lineno">16</span> <span class="p">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="kd">function</span> <span class="nx">step3</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">19</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno">20</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">step4</span><span class="p">);</span>
<span class="lineno">21</span> <span class="p">}</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="kd">function</span> <span class="nx">step4</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">24</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno">25</span> <span class="p">}</span>
</code></pre></div>

<p>这样看起来似乎好多了，代码从上到下，就是流程中的一个又一个步骤。不过还是有一点不好，你要为每一个步骤取一个名字，而这些名字仅仅是为了写回调函数参数时可以有所指代罢了。</p>

<p>如果不想为每一个步骤命个没太大意义的名，可以试试Promise方法：</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 3</span>     <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">);</span>
<span class="lineno"> 4</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
<span class="lineno"> 5</span>     <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">){</span>
<span class="lineno"> 6</span>         <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
<span class="lineno"> 7</span>         <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">resovle</span><span class="p">);</span>
<span class="lineno"> 8</span>     <span class="p">});</span>
<span class="lineno"> 9</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
<span class="lineno">10</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno">11</span> <span class="p">});</span>
</code></pre></div>

<p>这样就既避免了嵌套，又省去为函数命名的苦恼。但是依然有问题：</p>

<ol>
    <li>流程被分割了，确切的说，流程并非依照逻辑的相关程度，而仅仅按照是否有异步操作而被分割成不同部分。</li>
    <li>后面的匿名函数无法直接引用之前匿名函数中的变量。</li>
</ol>

<p>想象一下，有这么一个过程，它需要查询n次数据库，每次都会根据查询的结果进行不同的操作，在此过程中它需要维护一组变量，随时需要读和修改这组变量的值。如果是阻塞式I/O，同步调用，那么直接将此过程写成一个函数，需要维护的变量就写成一组局部变量好了。写起来简单，阅读起来一目了然。但如果I/O是非阻塞式的，调用是异步的，那么不论怎么写，都不能和同步代码那样简单明了。</p>

<p>如果Node.js也能写出同步代码就好了，哪怕是看起来像同步代码也好。是的，这篇文章的目的，就是探讨如何用Node.js写出看起来像同步调用的代码，我称之为<b>伪同步代码</b>。</p>

<h1 id="article-index-2"> ECMAScript 6 的新特性</h1>

<p>目前V8引擎已经支持ECMAScript 6的<b>部分</b>特性，比如我即将介绍的generator。如果想使用这些特性，请至少使用Node.js 0.11及以上版本，并且在运行node的时候加上--harmony参数。</p>

<p>如果你不了解generator，强烈建议你先看看<a href="http://javascript.ruanyifeng.com/advanced/ecmascript6.html#toc9" target="_blank" ref="nofollow">《JavaScript标准参考教程(alpha)》</a>3.7部分。我将假定你已经阅读过该部分了。</p>

<p>如何理解generator，我们可以把它理解成一种代码的<b>等效替换</b>。例如有如下一段代码。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="kd">function</span> <span class="nx">g</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>     <span class="kd">var</span> <span class="nx">flow</span> <span class="o">=</span> <span class="p">[</span>
<span class="lineno"> 3</span>         <span class="kd">function</span><span class="p">(){</span>
<span class="lineno"> 4</span>             <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Name:"</span><span class="o">+</span><span class="nx">name</span><span class="p">);</span>
<span class="lineno"> 5</span>             <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
<span class="lineno"> 6</span>         <span class="p">},</span>
<span class="lineno"> 7</span>         <span class="kd">function</span><span class="p">(){</span>
<span class="lineno"> 8</span>             <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Age:"</span><span class="o">+</span><span class="nx">age</span><span class="p">);</span>
<span class="lineno"> 9</span>             <span class="k">return</span> <span class="nx">age</span><span class="p">;</span>
<span class="lineno">10</span>         <span class="p">},</span>
<span class="lineno">11</span>         <span class="kd">function</span><span class="p">(){</span>
<span class="lineno">12</span>             <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="o">?</span> <span class="s2">"old"</span> <span class="o">:</span> <span class="s2">"young"</span><span class="p">);</span>
<span class="lineno">13</span>         <span class="p">},</span>
<span class="lineno">14</span>     <span class="p">];</span>
<span class="lineno">15</span>     <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">16</span>     <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
<span class="lineno">17</span>         <span class="k">if</span><span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">flow</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="s2">"error"</span><span class="p">;}</span>
<span class="lineno">18</span>         <span class="kd">var</span> <span class="nx">fun</span> <span class="o">=</span> <span class="nx">flow</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
<span class="lineno">19</span>         <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">20</span>         <span class="k">return</span> <span class="p">{</span>
<span class="lineno">21</span>             <span class="nx">done</span> <span class="o">:</span> <span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">flow</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="lineno">22</span>             <span class="nx">value</span> <span class="o">:</span> <span class="nx">fun</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
<span class="lineno">23</span>         <span class="p">}</span>
<span class="lineno">24</span>     <span class="p">}</span>
<span class="lineno">25</span>     <span class="k">return</span> <span class="p">{</span><span class="nx">next</span> <span class="o">:</span> <span class="nx">next</span><span class="p">};</span>
<span class="lineno">26</span> <span class="p">}</span>
</code></pre></div>

<p>可以用等效的generator代替。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span> <span class="kd">function</span><span class="o">*</span> <span class="nx">g</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Name:"</span><span class="o">+</span><span class="nx">name</span><span class="p">);</span>
<span class="lineno">3</span>     <span class="k">yield</span> <span class="nx">name</span><span class="p">;</span>
<span class="lineno">4</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Age:"</span><span class="o">+</span><span class="nx">age</span><span class="p">);</span>
<span class="lineno">5</span>     <span class="k">yield</span> <span class="nx">age</span><span class="p">;</span>
<span class="lineno">6</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="o">?</span> <span class="s2">"old"</span> <span class="o">:</span> <span class="s2">"young"</span><span class="p">);</span>
<span class="lineno">7</span> <span class="p">}</span>
</code></pre></div>

<p>第二段代码，和第一段代码的效果是完全一样的。显然第二段代码更易阅读，也更好写。</p>

<p>此外，对于generator又有另一种理解方式。在generator中使用yield关键字，可以让程序流执行至此时被中断，此时现场被保护起来，直到下次调用next()的时候，现场还能恢复，程序流从之前中断的地方继续执行。</p>

<h1 id="article-index-3">写出伪同步代码</h1>

<p>利用generator，我们可以写出看起来很像同步代码，但却是<b>异步执行</b>的代码。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">[</span>
<span class="lineno"> 4</span>     <span class="p">{</span>
<span class="lineno"> 5</span>         <span class="nx">host</span> <span class="o">:</span> <span class="s1">'www.baidu.com'</span><span class="p">,</span>
<span class="lineno"> 6</span>         <span class="nx">port</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
<span class="lineno"> 7</span>         <span class="nx">page</span> <span class="o">:</span> <span class="s1">'/'</span>
<span class="lineno"> 8</span>     <span class="p">},</span>
<span class="lineno"> 9</span>     <span class="p">{</span>
<span class="lineno">10</span>         <span class="nx">host</span> <span class="o">:</span> <span class="s1">'www.google.com'</span><span class="p">,</span>
<span class="lineno">11</span>         <span class="nx">port</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
<span class="lineno">12</span>         <span class="nx">page</span> <span class="o">:</span> <span class="s1">'/'</span>
<span class="lineno">13</span>     <span class="p">},</span>
<span class="lineno">14</span>     <span class="p">{</span>
<span class="lineno">15</span>         <span class="nx">host</span> <span class="o">:</span> <span class="s1">'taozeyu.com'</span><span class="p">,</span>
<span class="lineno">16</span>         <span class="nx">port</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
<span class="lineno">17</span>         <span class="nx">page</span> <span class="o">:</span> <span class="s1">'/'</span>
<span class="lineno">18</span>     <span class="p">},</span>
<span class="lineno">19</span> <span class="p">];</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="kd">function</span><span class="o">*</span> <span class="nx">printStatusCode</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">22</span>     <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">options</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">23</span>         <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span><span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="p">});</span>
<span class="lineno">24</span>         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
<span class="lineno">25</span>     <span class="p">}</span>
<span class="lineno">26</span> <span class="p">};</span>
<span class="lineno">27</span> 
<span class="lineno">28</span> <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">printStatusCode</span><span class="p">();</span>
<span class="lineno">29</span> <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</code></pre></div>

<p>这段小程序按顺序先后访问www.baidu.com、www.google.com、taozeyu.com这三个网站，然后分别打印出服务器返回的statusCode。其中http.get()函数一定是异步执行的，但是程序视觉上却有些同步执行的感觉。</p>

<p>但是，仅仅使用generator并不能在所有情况下都能写出伪同步代码。例如，如果有两个函数A，B。其中A必须调用B。且A与B中都有多个地方需要执行异步操作。这种情况下仅用generator就写不出来（或写不好）。此时，我们需要再做一层封装。</p>

<p>作为实验，我写了一个叫做dollar的库，可以去<a href="https://github.com/taozeyu/dollar" target="_blank" ref="nofollow">github.com/taozeyu/dollar</a>查看源代码。我将演示下用dollar库如何写出伪同步代码。在下集中，我将讲下dollar库的思路。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="lineno"> 2</span> <span class="kd">var</span> <span class="nx">D</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'dollar'</span><span class="p">);</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="kd">var</span> <span class="nx">get$</span> <span class="o">=</span> <span class="nx">D</span><span class="p">.</span><span class="nx">async</span><span class="p">(</span><span class="nx">http</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="nx">D</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(){</span>
<span class="lineno"> 7</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"ready to load..."</span><span class="p">);</span>
<span class="lineno"> 8</span>     <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 9</span>         <span class="nx">host</span> <span class="o">:</span> <span class="s1">'www.douban.com'</span><span class="p">,</span>
<span class="lineno">10</span>         <span class="nx">port</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
<span class="lineno">11</span>         <span class="nx">page</span> <span class="o">:</span> <span class="s1">'/good-good-study-day-day-up'</span>
<span class="lineno">12</span>     <span class="p">};</span>
<span class="lineno">13</span>     <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">get$</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="lineno">14</span>     <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">15</span>         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"success"</span><span class="p">);</span>
<span class="lineno">16</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">17</span>         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"fail : "</span><span class="o">+</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
<span class="lineno">18</span>     <span class="p">}</span>
<span class="lineno">19</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"complite"</span><span class="p">);</span>
<span class="lineno">20</span> <span class="p">});</span>
</code></pre></div>

<p>使用dollar库时，建议使用大写的D来表示，因为D可能写在代码的各个地方，如果用某个较长的词代替，这个词可能填充得到处都是。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">D</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'dollar'</span><span class="p">);</span>
</code></pre></div>

<p>使用D.async()包装某个只能异步调用的函数，使之变成同步函数。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">get$</span> <span class="o">=</span> <span class="nx">D</span><span class="p">.</span><span class="nx">async</span><span class="p">(</span><span class="nx">http</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
</code></pre></div>

<p>这样，我们就将http.get这个异步函数，包装成了一个名为get$的同步函数。建议将包装后的函数名字结尾加上$符，这样一眼就可以看出哪个函数是包装过的。</p>

<p>当我们想要调用get$()函数时，在之前加上yield关键字，且保证调用在D.start(function* (){...})之中即可。

</p><div class="highlight"><pre><code class="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">get$</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
</code></pre></div>

<p>如此一来，我们就写出了看起来像同步执行的实际却是异步执行的<b>伪同步</b>代码。写代码时，只要记得一看见名字以$结尾的函数，调用时就在它前面加上一个yield关键字，那么写代码来就和同步无异。</p>

<p>现在考虑之前说的那种情况，有两个函数A，B。其中A必须调用B。且A与B中都有多个地方需要执行异步操作。此时，我们只需把B函数包装一下即可。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="lineno"> 2</span> <span class="kd">var</span> <span class="nx">D</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'dollar'</span><span class="p">);</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="kd">var</span> <span class="nx">get$</span> <span class="o">=</span> <span class="nx">D</span><span class="p">.</span><span class="nx">async</span><span class="p">(</span><span class="nx">http</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="kd">var</span> <span class="nx">getStateCode$</span> <span class="o">=</span> <span class="nx">D</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">host</span><span class="p">){</span>
<span class="lineno"> 7</span>     <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 8</span>         <span class="nx">host</span> <span class="o">:</span> <span class="nx">host</span><span class="p">,</span>
<span class="lineno"> 9</span>         <span class="nx">port</span> <span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
<span class="lineno">10</span>         <span class="nx">page</span> <span class="o">:</span> <span class="s1">'/good-good-study-day-day-up'</span>
<span class="lineno">11</span>     <span class="p">};</span>
<span class="lineno">12</span>     <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">get$</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="lineno">13</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"get code:"</span><span class="o">+</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
<span class="lineno">14</span>     <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span>
<span class="lineno">15</span> <span class="p">});</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="nx">D</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(){</span>
<span class="lineno">18</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"ready to load..."</span><span class="p">);</span>
<span class="lineno">19</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"status code :"</span><span class="o">+</span><span class="p">(</span><span class="k">yield</span> <span class="nx">getStateCode$</span><span class="p">(</span><span class="s2">"www.baidu.com"</span><span class="p">)));</span>
<span class="lineno">20</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"status code :"</span><span class="o">+</span><span class="p">(</span><span class="k">yield</span> <span class="nx">getStateCode$</span><span class="p">(</span><span class="s2">"www.douban.com"</span><span class="p">)));</span>
<span class="lineno">21</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"status code :"</span><span class="o">+</span><span class="p">(</span><span class="k">yield</span> <span class="nx">getStateCode$</span><span class="p">(</span><span class="s2">"taozeyu.com"</span><span class="p">)));</span>
<span class="lineno">22</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"done"</span><span class="p">);</span>
<span class="lineno">23</span> <span class="p">});</span>
</code></pre></div>

<p>请注意这种用法，同包装http.get这种函数一样，包装过的函数命名时也建议在末尾加上$符，因为调用这种函数也必须在之前加yield关键字。</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">getStateCode$</span> <span class="o">=</span> <span class="nx">D</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(...){...});</span>
</code></pre></div>

<p>OK，至此，我们似乎得到了一个可以将Node.js在各种情况下都能写出同步代码的方案，真是如此吗？不是的，还有异常处理呢。这部分我留在再下一篇文章中再写吧。</p>
			</div>
            <div class="statement">
                
				<p>你正阅读的这篇文章版权归 <a href="http://taozeyu.com" target="_blank">taozeyu.com</a> 所有。</p>
				<p>转载请注明出处为 <a href="http://taozeyu.com" target="_blank">MOsky的博客</a> ，请勿用作商业用途。</p>
                
			</div>
            <div id="comments">
            <!-- Duoshuo Comment BEGIN -->
                <div class="ds-thread" id="ds-thread"><div id="ds-reset"><div class="ds-meta"><a href="javascript:void(0)" class="ds-like-thread-button ds-rounded ds-thread-liked"><span class="ds-icon ds-icon-heart"></span> <span class="ds-thread-like-text">已喜欢</span><span class="ds-thread-cancel-like">取消喜欢</span></a><span class="ds-like-panel"><span class="ds-highlight">1</span> 人喜欢</span></div><div class="ds-comments-info"><div class="ds-sort"><a class="ds-order-desc ds-current">最新</a><a class="ds-order-asc">最早</a><a class="ds-order-hot">最热</a></div><ul class="ds-comments-tabs"><li class="ds-tab"><a class="ds-comments-tab-duoshuo ds-current" href="javascript:void(0);">评论</a></li></ul></div><ul class="ds-comments"><li class="ds-post ds-post-placeholder">还没有评论，沙发等你来抢</li></ul><div class="ds-paginator" style="display: none;"><div class="ds-border"></div><a data-page="1" href="javascript:void(0);" class="ds-current">1</a></div><a name="respond"></a><div class="ds-toolbar"><div class="ds-account-control"><span class="ds-icon ds-icon-settings"></span> <span>帐号管理</span><ul><li><a class="ds-bind-more" href="javascript:void(0);" style="border-top: none">绑定更多</a></li><li><a target="_blank" href="http://duoshuo.com/settings/">设置</a></li><li><a rel="nofollow" href="http://taozeyu.duoshuo.com/logout/" style="border-bottom: none">登出</a></li></ul></div><div class="ds-visitor"><a class="ds-visitor-name" href="http://taozeyu.com" target="_blank">MOskize</a><a class="ds-unread-comments-count" href="javascript:void(0);" title="你没有新回复" style="display: none;">0</a></div></div><div class="ds-replybox"><a class="ds-avatar" href="http://duoshuo.com/settings/avatar/" target="_blank" title="设置头像"><img src="http://q.qlogo.cn/qqapp/100229475/0506C3743027A35099FA6D4F6433C016/100" alt="MOskize"></a><form method="post"><input type="hidden" name="thread_id" value="1204432524856524818">
<input type="hidden" name="parent_id" value="">
<input type="hidden" name="nonce" value="53632083b0107"><div class="ds-textarea-wrapper ds-rounded-top"><textarea name="message" title="Ctrl+Enter快捷提交" placeholder="说点什么吧…"></textarea><pre class="ds-hidden-text"></pre></div><div class="ds-post-toolbar"><div class="ds-post-options ds-gradient-bg"><span class="ds-sync"><input id="ds-sync-checkbox" type="checkbox" name="repost" value=""> <label for="ds-sync-checkbox">分享到:</label><a href="javascript:void(0)" class="ds-service-icon-grey ds-weibo" data-service="weibo" title="新浪微博"></a><a href="javascript:void(0)" class="ds-service-icon-grey ds-qqt" data-service="qqt" title="腾讯微博"></a><a href="javascript:void(0)" class="ds-service-icon-grey ds-qzone" data-service="qzone" title="QQ空间"></a></span></div><button class="ds-post-button" type="submit">发布</button><div class="ds-toolbar-buttons"><a class="ds-toolbar-button ds-add-emote" title="插入表情"></a></div></div></form></div><p class="ds-powered-by"><a href="http://duoshuo.com" target="_blank" rel="nofollow">MOsky的博客正在使用多说</a></p></div></div>
                <script type="text/javascript">
                    var duoshuoQuery = {short_name:"taozeyu"};
                    (function() {
                        var ds = document.createElement('script');
                        ds.type = 'text/javascript';ds.async = true;
                        ds.src = 'http://static.duoshuo.com/embed.js';
                        ds.charset = 'UTF-8';
                        (document.getElementsByTagName('head')[0] 
                        || document.getElementsByTagName('body')[0]).appendChild(ds);
                    })();
                </script>
            </div>
        </div>
    </div>

<div id="ds-notify" style="top: 24px; right: 24px; display: none;"><div id="ds-reset"><a class="ds-logo" href="http://duoshuo.com/" target="_blank" title="多说"></a><ul class="ds-notify-unread"><li style="display:none;"><a data-type="unread-comments" href="javascript:void(0);">你有undefined条新回复</a></li><li style="display:none;"><a data-type="unread-notifications" href="javascript:void(0);">你有undefined条系统消息</a></li></ul></div></div></body></html>